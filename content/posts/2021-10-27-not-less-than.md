---
title: 连续不低于
author: yuanfan
date: '2021-11-01'
slug: not-less-than
categories:
  - Living
tags:
  - 生活
draft: no
---

随着前两个月被抓去做原型设计[^1]，接着又被抓去做测试，最近被抓去做数据开发了……

<!--more-->

开发过程中遇到了一个小问题，大致场景是：

>公司中每个客户都有一个等级，客户等级总会发生变更，这些等级中C(Common)代表普通等级，S(Silver)代表银卡等级，G(Golden)代表金卡等级，P(Platinum)代表铂金卡等级，等级顺序依次是C<S<G<P，求每个客户连续不低于银卡等级的时间、连续不低于金卡等级的时间、连续不低于铂金卡等级的时间？

|list_id|customer_id|old_level|new_level|insert_time|
|:--:|:--:|:--:|:--:|:--:|
|1|123456|C|S|2010/10/14 01:11:51|
|2|123456|S|G|2011/02/19 08:47:49|
|3|123456|G|C|2014/11/11 11:45:36|
|4|123456|C|S|2015/11/11 10:55:01|
|5|123456|S|G|2016/11/11 09:55:32|
|6|123456|G|P|2019/11/11 12:11:11|

上面这个表格中的数据是我瞎编的一个例子，客户ID为123456的这位客户在2010年成为银卡客户，在2011年升级为金卡客户，又在2014年降级成为普通客户，随后又在2015年重新升级为银卡客户，其后客户等级保持连续不低于银卡等级，所以该客户连续不低于银卡等级的时间是`2015/11/11`。

这个小问题是要在ORACLE中写SQL解决。最开始我困在“连续”这个词中，解题思路想得极其复杂，寻思着把代表等级的C/S/G/P等字母替换成可以直接比较大小的数字，每个客户按等级变更的时间顺序排序，然后把排序得到的序号作为父节点去用递归函数写条件依次判断……哈哈，我自己也觉得这个问题被我想复杂了，所以当时也没有直接按原来的思路去做，而是先放着干别的去了。过了两天，在把一些贼难、贼麻烦、贼耗时间的问题弄得差不多以后，才回过头来再处理这个问题。

可是我还是想不到简单解法，于是就把这个问题拿去问了同事小花，小花给了我一个很简单的思路：把“不连续”的变更记录直接去掉，然后对时间取最小值。

```{sql}
select t.customer_id, min(ch.insert_time)
  from t_base t  --确定数据范围的基础表，瞎编的表名
  left join t_vip_change ch on t.customer_id = ch.customer_id  --t_vip_change也是瞎编的表名
 where ch.new_level in ('S', 'G', 'P')
   and not exists (select '1'
          from t_vip_change ch2
         where ch2.customer_id = ch.customer_id
           and ch2.new_level not in ('S', 'G', 'P')
           and ch2.insert_time > ch.insert_time)
 group by t.customer_id;
```

这件小事在我心里放了几天，又延伸思考了几点：

+ 这个问题用R怎么解？

+ 会的方法多了以后，是否容易陷入“乱花渐欲迷人眼[^2]”的状况中？

+ 我本人是否缺乏面对问题死磕到底的精神？或者说我是不是有什么奇怪的问题定位能力？

### 用R解题

有个叫sqldf的包可以在R里面写sql，但是跑数不够快。倒也可以用写sql的逻辑再用data.table写一遍，但总觉得哪里怪怪的。作为一个R新手，忽然有些疑惑用R和sql做数据处理的边界在哪里。我现在做的模型，正式开发时生成特征那一步是在数据库里写存储过程，然后在R脚本里完成连接数据库取写好的特征、调包跑模型、再把跑出来的结果传回数据库，最后对存储过程和R脚本设置调度，最后把每天跑出来的结果数据供给前端展示。其实我只需要把东西做出来，没人会管我是怎么做出来的，就算我非要把所有步骤挪到R上面做也没人会在意的。所以，对现在的我来说，这个边界其实可以不存在，怎么方便怎么来即可。

不知是我视野太狭窄还是我水平太菜，这个“连续不低于”的问题想来想去还是觉得用sql写更容易一些，R里面的数据处理似乎更强调把每一列作为操作的对象，不好对每一行做复杂操作，尤其是自己跟自己关联做筛选这种情况。或者应该说，我又一次思路受限了，sql本来就是查询语言，干嘛非要跟R拼数据处理哪家强；而R本来也是只能连接数据库，不能存储数据，干嘛要跟sql拼查询逻辑哪家强。

### 乱花渐欲迷人眼

小花说正是因为她本来就不会递归那些东西，所以思考解决方法时才更倾向于越简单越好，而我是因为会的复杂方法多，才会想得太复杂。

其实我总觉得我会的东西还太少，总想着要学会更多。一路走，一路收获，一路改变，看过的东西越来越多，却仍然没弄明白究竟想走的是一条什么路。好了，不矫情了，路是人走出来的，不是想出来的。

### 任何时候都该死磕到底吗？

最近开发的时候还碰到另一个问题，我也没有立刻去解决，而是先放着。有些数据的计算逻辑要复用别的系统的，如果每天全量更新跑一次要10个小时，所以需要提高跑数的效率。领导给的方案是让我改写成多线程，但这个我不会，所以也给了一个例子让我现学现用。当时看了例子后，我以为改写的话要把复用的十几个方法几千行代码全部捋一遍，于是嫌工作量太大不想那么干。正好也知道别的系统正在对那块的逻辑进行优化，一问，那边的开发人员居然都差不多优化完了马上都要提交代码了，而且他们优化的重点是除了能跑得更快，还把全量更新改为增量更新了。哈哈，于是乎，选后者。

五月份的时候，大概是5.3日凌晨我写了一篇博客准备发出去然而博客页面怎么也找不到最新那篇，我磕了大概一个小时，琢磨着可能是时区的问题就把日期改成5.2日后发出去了。后来还把这件事发到了[统计之都论坛](https://d.cosx.org/d/422234)里，哈哈，想不到竟然也有小伙伴遇到过这种情况还死磕了一晚上。

也有会一直磕的时候，比如想用echarts4r在一个框框里画四个图，断断续续磕了很多次最后发现就是无法实现。比如以前嫌我博客正文里文字占页面比例太少了，惦记着、摸索着改了很多次，最近终于找对地方改好了。

应该确实是缺少死磕到底的精神，因为很少有事情会令我废寝忘食去做。面对一个问题的时候，通常会先判断这是需要花少量时间可以完成的，还是需要花大量时间才可以完成的。如果要累积很久才能做成的事情，也就是不能一次完成要分成很多次去尝试的事，多半会把这件事放到心里一直记着，然后量力而为。也许就是因为总抱着这种“量力而为”的心态，致使我难以竭尽全力去做一件事？或者换个名字，这应该是叫做“成年人的丧”，若是一件事被自己判定为希望渺茫就不会过多去期待了。

如果工作中碰到只能孤军奋战的问题还是得死磕，但有些问题还是虚心求教更好。比如做数据开发时我还遇到过一个超过我能力上限的问题，这个上限并不是指难度或复杂度方面，而是因为开发本来就不是我擅长的领域，有些开发的基础方法我不会写。这个问题大致可这样描述：

>用户在前台页面根据业务需求配置出一些规则，理论上可以配置无数条规则，每条规则中有一个必要选项、多个非必要选项，有的可以单选，有的可以多选。这些配置好的规则会存入后台数据库的表里，我要做的就是取表中数据，根据规则内容匹配出符合规则所代表的条件的客户，然后再匹配一些别的内容存到另外的表里传给别的地方做展示。

规则会变，所以不能手动根据规则内容匹配，而应让数据自动批量匹配。最开始我是寻思着每条规则都不一样，所以只能写方法去自动一条一条匹配，于是请教了开发人员，提供的思路是让动态拼接查询条件，可惜本菜鸟根本不会这个。后来又请教了别的同事，又鼓捣了一上午终于找到一个我的开发能力范围内的思路，可是又被通知这个问题不需要我做了，亏我之前还有一小丢丢担心自己会搞不定拖慢整体进度呢。

[^1]:主要是做可视化页面的原型设计，就是用R中的flexdashboard包+echarts4r包画图，偶尔用kableExtra包做表格。

[^2]:乱花渐欲迷人眼的个人定义是，简单问题却想得过于复杂，难以透过现象看清本质，容易执迷于问题的表象而忽略根本。
